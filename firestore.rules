rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // ===================================================================
    // Identity Helpers
    // ===================================================================

    function isSignedIn() {
      return request.auth != null;
    }

    function currentUid() {
      return isSignedIn() ? request.auth.uid : null;
    }

    function isSuperAdmin() {
      return isSignedIn() && (
        request.auth.token.superadmin == true ||
        request.auth.token.email == 'umityeke@gmail.com'
      );
    }

    function isSystemWriter() {
      return isSignedIn() && (
        request.auth.token.system_writer == true ||
        request.auth.token.app_server == true ||
        request.auth.token.backend == true
      );
    }

    function ownerMatchesDocId(docId) {
      return isSignedIn() && docId == currentUid();
    }

    function serverSideWrite() {
      return isSystemWriter() || isSuperAdmin();
    }

    // ===================================================================
    // Users (auth metadata mirrored from MSSQL)
    // ===================================================================

    match /users/{userId} {
      // Clients sadece kendi kayıtlarını okuyabilir, super admin her şeyi görebilir
      allow get: if ownerMatchesDocId(userId) || isSuperAdmin();
      allow list: if false;

      // Yazma hakları sadece backend servislerinde
      allow create: if serverSideWrite();
      allow update: if serverSideWrite();
      allow delete: if isSuperAdmin();
    }

    // ===================================================================
    // Kullanıcı güvenlik dokümanları (cihaz fingerprint, oturum kayıtları)
    // ===================================================================

    match /user_security/{userId} {
      allow get, list: if ownerMatchesDocId(userId) || isSuperAdmin();
      allow create: if serverSideWrite();
      allow update: if serverSideWrite();
      allow delete: if serverSideWrite();
    }

    // ===================================================================
    // Oturum sinyalleri (client-side telemetry) - sadece backend yazar
    // ===================================================================

    match /session_signals/{userId}/{signalId} {
      allow get, list: if ownerMatchesDocId(userId) || isSuperAdmin();
      allow create: if serverSideWrite();
      allow update: if false;
      allow delete: if serverSideWrite();
    }

    // ===================================================================
    // MSSQL'den türetilen herkese açık cache koleksiyonları (sadece okuma)
    // ===================================================================

    match /public_profiles/{uid} {
      allow get, list: if true;
      allow create, update, delete: if serverSideWrite();
    }

    match /public_follow_counts/{uid} {
      allow get, list: if true;
      allow create, update, delete: if serverSideWrite();
    }

    match /public_entry_counts/{uid} {
      allow get, list: if true;
      allow create, update, delete: if serverSideWrite();
    }

    // ===================================================================
    // Takip grafiği sadece okuma amaçlı; yazma sadece backend'den
    // ===================================================================

    match /follows/{ownerId}/following/{targetId} {
      allow get, list: if ownerMatchesDocId(ownerId) || isSuperAdmin();
      allow create, update, delete: if serverSideWrite();
    }

    match /follows_index/{ownerId}/{kind}/{targetId} {
      allow get, list: if ownerMatchesDocId(ownerId) || isSuperAdmin();
      allow create, update, delete: if serverSideWrite();
    }

    // ===================================================================
    // Sistemsel ayarlar ve kilitler
    // ===================================================================

    match /system_config/{docId} {
      allow get: if isSignedIn();
      allow list: if isSuperAdmin();
      allow create, update, delete: if serverSideWrite();
    }

    match /config_messaging/{docId} {
      allow get: if isSignedIn();
      allow list: if false;
      allow create, update, delete: if serverSideWrite();
    }

    match /system_cache/{bucketId}/{docId} {
      allow get, list: if serverSideWrite() || isSuperAdmin();
      allow create, update, delete: if serverSideWrite();
    }

    // ===================================================================
    // Varsayılan: her şeyi reddet
    // ===================================================================

    match /{document=**} {
      allow read, write: if false;
    }
  }
}